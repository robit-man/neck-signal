<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NKN Viewer (Browser)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- NKN SDK (browser build) -->
  <script src="https://unpkg.com/nkn-sdk@1.3.6/dist/nkn.min.js"></script>
  <style>
    :root {
      --bg: #0b0f14; --fg: #ecf2f8; --muted:#9fb3c8; --accent:#4dd0ff; --danger:#ff5c5c;
      --panel:#121821; --panel2:#1a2230; --overlay:rgba(0,0,0,.55);
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--fg); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif; }
    header { padding:10px 14px; background:var(--panel); border-bottom:1px solid #0e141c; display:flex; gap:12px; align-items:center; }
    header h1 { font-size:14px; margin:0; font-weight:600; letter-spacing:.5px; }
    header .chip { padding:4px 8px; border-radius:999px; background:var(--panel2); color:var(--muted); }
    main { display:flex; gap:10px; padding:12px; height:calc(100% - 54px); box-sizing:border-box; }
    .view { flex:1; position:relative; border:1px solid #0e141c; border-radius:8px; overflow:hidden; background:#000; min-height:200px; }
    .view canvas, .view img { width:100%; height:100%; display:block; object-fit:contain; background:#000; }
    .overlay {
      position:absolute; left:0; top:0; right:0; height:40px; background:linear-gradient(180deg, rgba(0,0,0,.6), rgba(0,0,0,0));
      display:flex; align-items:center; gap:12px; padding:8px 10px; box-sizing:border-box; pointer-events:none; font-size:12px;
    }
    .overlay .tag { background:rgba(255,255,255,.12); padding:3px 8px; border-radius:999px; }
    .bar { display:flex; gap:8px; align-items:center; margin-left:auto; }
    .btn { background:var(--panel2); border:1px solid #1f2a3a; color:var(--fg); padding:8px 12px; border-radius:6px; cursor:pointer; }
    .btn:hover { filter:brightness(1.15); }
    .muted { color:var(--muted); }

    /* Modal */
    .modal-backdrop {
      position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .modal { width:min(560px, 92vw); background:var(--panel); border:1px solid #1b2533; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .modal header { background:transparent; border:0; padding:14px 16px; }
    .modal h2 { margin:0; font-size:16px; }
    .modal .content { padding:0 16px 16px 16px; }
    .form { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .form .row { display:flex; flex-direction:column; gap:6px; }
    .form label { font-size:12px; color:var(--muted); }
    .form input[type="text"], .form input[type="number"] {
      background:#0f1520; border:1px solid #1f2a3a; color:var(--fg); border-radius:6px; padding:8px 10px; outline:none;
    }
    .form input[type="checkbox"] { transform:scale(1.1); }
    .form .row span.help { font-size:11px; color:var(--muted); }
    .modal footer { display:flex; gap:10px; padding:12px 16px 16px; justify-content:flex-end; }
    .err { color:var(--danger); font-size:12px; margin-top:6px; min-height:1em; }
    .hidden { display:none !important; }
    .statusline { padding:0 12px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>NKN Viewer</h1>
    <span class="chip" id="addrChip">addr: —</span>
    <span class="chip" id="topicChip">topic: —</span>
    <div class="bar">
      <button class="btn" id="openSettings">Settings</button>
      <button class="btn" id="restartBtn">Restart</button>
    </div>
  </header>

  <main>
    <section class="view" id="colorView">
      <div class="overlay"><span class="tag">COLOR</span><span class="muted" id="colorMeta"></span></div>
      <canvas id="colorCanvas"></canvas>
    </section>
    <section class="view" id="depthView" style="display:none">
      <div class="overlay"><span class="tag">DEPTH</span><span class="muted" id="depthMeta"></span></div>
      <canvas id="depthCanvas"></canvas>
    </section>
  </main>
  <div class="statusline" id="status">idle</div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header><h2 id="modalTitle">Viewer Settings</h2></header>
      <div class="content">
        <form id="cfgForm" class="form">
          <div class="row">
            <label>Server Host</label>
            <input id="serverHost" type="text" placeholder="127.0.0.1" />
            <span class="help">HTTP bootstrap host</span>
          </div>
          <div class="row">
            <label>Server Port</label>
            <input id="serverPort" type="number" min="1" max="65535" placeholder="3000" />
            <span class="help">HTTP bootstrap port</span>
          </div>
          <div class="row" style="grid-column:1 / span 2">
            <label>Agent UUID</label>
            <input id="viewUuid" type="text" placeholder="agent-uuid" />
          </div>
          <div class="row">
            <label>Show Depth</label>
            <div><input id="showDepth" type="checkbox" /></div>
          </div>
          <div class="row">
            <label>FPS Cap</label>
            <input id="fpsCap" type="number" min="1" max="120" step="1" placeholder="30" />
          </div>
          <div class="row" style="grid-column:1 / span 2">
            <label>Client Seed (hex, 64 chars) — optional</label>
            <input id="clientSeed" type="text" placeholder="auto-generated & stored if empty" />
            <span class="help">Persistent seed provides a stable NKN address.</span>
          </div>
          <div class="row" style="grid-column:1 / span 2">
            <div class="err" id="formErr"></div>
          </div>
        </form>
      </div>
      <footer>
        <button class="btn" id="cancelBtn">Cancel</button>
        <button class="btn" id="saveBtn">Save & Start</button>
      </footer>
    </div>
  </div>

  <script>
  ;(() => {
    // ──────────────────────────────────────────────────────────────────────────
    // Utilities
    // ──────────────────────────────────────────────────────────────────────────
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const toHex = (buf) => Array.from(buf).map(b => b.toString(16).padStart(2,'0')).join('');
    const fromB64 = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const looksLikeNknAddr = s => /^[A-Za-z0-9_-]+\.[0-9a-f]{64}$/.test((s||'').trim());
    const now = () => performance.now() / 1000; // seconds

    const LS = {
      read() {
        try { return JSON.parse(localStorage.getItem('nkn_viewer_cfg')||'{}'); }
        catch { return {}; }
      },
      write(cfg) { localStorage.setItem('nkn_viewer_cfg', JSON.stringify(cfg)); }
    };

    // Robust percentiles (for depth normalization)
    function percentile(arr, p) {
      if (!arr.length) return 0;
      const idx = Math.min(arr.length - 1, Math.max(0, Math.floor((p/100)*arr.length)));
      // nth_element style approximation to avoid full sort on every frame
      // For simplicity here, we just sort on a copy (OK for moderate sizes).
      const a = arr.slice().sort((x,y)=>x-y);
      return a[idx];
    }

    // ──────────────────────────────────────────────────────────────────────────
    // App State
    // ──────────────────────────────────────────────────────────────────────────
    const state = {
      serverSig: null,
      topicPrefix: 'roko-signaling',
      clientAddr: null,
      client: null,
      stats: { frames:0, bytes:0, t0: now(), fps:0, bps:0 },
      fpsCap: 30,
      uuid: '',
      showDepth: false,
      running: false
    };

    const ui = {
      colorCanvas: $('#colorCanvas'),
      depthCanvas: $('#depthCanvas'),
      colorMeta: $('#colorMeta'),
      depthMeta: $('#depthMeta'),
      addrChip: $('#addrChip'),
      topicChip: $('#topicChip'),
      status: $('#status'),
      depthView: $('#depthView'),
    };

    const ctxColor = ui.colorCanvas.getContext('2d');
    const ctxDepth = ui.depthCanvas.getContext('2d');

    // ──────────────────────────────────────────────────────────────────────────
    // Modal
    // ──────────────────────────────────────────────────────────────────────────
    const modal = {
      backdrop: $('#modalBackdrop'),
      open() { this.backdrop.style.display = 'flex'; },
      close() { this.backdrop.style.display = 'none'; },
      fillFromLS() {
        const cfg = LS.read();
        $('#serverHost').value = cfg.serverHost || '127.0.0.1';
        $('#serverPort').value = cfg.serverPort || 3000;
        $('#viewUuid').value   = cfg.viewUuid   || '';
        $('#showDepth').checked= !!cfg.showDepth;
        $('#fpsCap').value     = cfg.fpsCap || 30;
        $('#clientSeed').value = cfg.clientSeed || '';
      },
      grab() {
        const serverHost = $('#serverHost').value.trim();
        const serverPort = parseInt($('#serverPort').value, 10) || 3000;
        const viewUuid   = $('#viewUuid').value.trim();
        const showDepth  = $('#showDepth').checked;
        const fpsCap     = Math.max(1, Math.min(120, parseInt($('#fpsCap').value, 10) || 30));
        let clientSeed   = $('#clientSeed').value.trim().toLowerCase().replace(/^0x/,'');
        if (clientSeed && !/^[0-9a-f]{64}$/.test(clientSeed)) {
          throw new Error('Client seed must be 64 hex chars (32 bytes).');
        }
        return { serverHost, serverPort, viewUuid, showDepth, fpsCap, clientSeed };
      },
      save(cfg) {
        LS.write(cfg);
      }
    };

    // Buttons
    $('#openSettings').addEventListener('click', () => {
      modal.fillFromLS();
      modal.open();
    });
    $('#cancelBtn').addEventListener('click', () => modal.close());
    $('#saveBtn').addEventListener('click', async () => {
      const err = $('#formErr'); err.textContent = '';
      try {
        const cfg = modal.grab();
        modal.save(cfg);
        modal.close();
        await restart();
      } catch (e) {
        err.textContent = e.message || String(e);
      }
    });
    $('#restartBtn').addEventListener('click', () => restart());

    // ──────────────────────────────────────────────────────────────────────────
    // Bootstrap: fetch server sig/topic from local HTTP endpoint
    // ──────────────────────────────────────────────────────────────────────────
    async function fetchBootstrap(host, port) {
      const url = `http://${host}:${port}/`;
      ui.status.textContent = `bootstrapping from ${url} …`;
      try {
        const r = await fetch(url, { method:'GET' });
        const data = await r.json();
        if (data && data.ok && typeof data.nknAddress === 'string') {
          return {
            SERVER_SIG: data.nknAddress,
            TOPIC_PREFIX: data.topicPrefix || 'roko-signaling'
          };
        }
      } catch (e) {
        console.warn('bootstrap failed', e);
      }
      return null;
    }

    // ──────────────────────────────────────────────────────────────────────────
    // NKN client (browser) — MultiClient
    // ──────────────────────────────────────────────────────────────────────────
    function getOrCreateSeedHex(userSeed) {
      if (userSeed) return userSeed;
      let hex = localStorage.getItem('CLIENT_NKN_SEED_HEX');
      if (/^[0-9a-f]{64}$/.test(hex||'')) return hex;
      const arr = new Uint8Array(32);
      (crypto || window.msCrypto).getRandomValues(arr);
      hex = toHex(arr);
      localStorage.setItem('CLIENT_NKN_SEED_HEX', hex);
      return hex;
    }

    function normalizeInbound(a, b) {
      // Matches the Python bridge logic: support (src,payload) or object forms
      if (a && typeof a === 'object' && (a.payload !== undefined || a.data !== undefined || a.src !== undefined || a.from !== undefined)) {
        const src = a.src || a.from || a.addr || '';
        const payload = (a.payload !== undefined) ? a.payload : a.data;
        return { src, payload };
      }
      return { src: a, payload: b };
    }

    function payloadToString(payload) {
      if (payload == null) return '';
      try {
        if (payload instanceof Uint8Array) return new TextDecoder().decode(payload);
        if (typeof payload === 'string') return payload;
        if (typeof payload === 'object') return JSON.stringify(payload);
        return String(payload);
      } catch { return ''; }
    }

    async function startClient({ seedHex, identifier='viewer' }) {
      // For browser usage, nkn-sdk exposes global "nkn" with Client and MultiClient; use MultiClient for reliability. (CDN dist) :contentReference[oaicite:1]{index=1}
      const client = new nkn.MultiClient({ seed: seedHex, identifier });
      ui.status.textContent = 'connecting to NKN …';
      client.onConnect(() => {
        ui.status.textContent = 'NKN ready';
        state.clientAddr = client.addr;
        ui.addrChip.textContent = `addr: ${client.addr}`;
        // Immediately announce as viewer
        if (looksLikeNknAddr(state.serverSig)) {
          client.send(state.serverSig, JSON.stringify({ event:'viewer-hello', uuid: state.uuid }));
        }
      });

      // message event: API forwards either (src, payload) or a single object
      client.on('message', (a, b) => {
        try {
          const { src, payload } = normalizeInbound(a, b);
          const txt = payloadToString(payload);
          let body = {};
          try { body = JSON.parse(txt); } catch { body = { raw: txt }; }
          handleInbound(src, body);
        } catch (e) {
          console.warn('bad inbound', e);
        }
      });

      window.addEventListener('beforeunload', () => {
        try { client.send(state.serverSig, JSON.stringify({ event:'viewer-bye', uuid: state.uuid })); } catch {}
      });

      return client;
    }

    function updateStats(nbytes) {
      const t = now();
      state.stats.frames += 1;
      state.stats.bytes  += nbytes;
      const dt = t - state.stats.t0;
      if (dt >= 1.0) {
        state.stats.fps = state.stats.frames / dt;
        state.stats.bps = state.stats.bytes / dt;
        state.stats.frames = 0;
        state.stats.bytes  = 0;
        state.stats.t0 = t;
      }
    }

    // ──────────────────────────────────────────────────────────────────────────
    // Frame handling
    // ──────────────────────────────────────────────────────────────────────────
    const latest = {
      color: { img: null, ts: 0, bytes: 0 },
      depth: { data: null, ts: 0, bytes: 0, isImage: true } // if not image, raw u16
    };

    function handleInbound(src, body) {
      const ev = body && body.event;
      if (!ev) return;

      if (ev === 'viewer-ack') {
        ui.status.textContent = `viewer-ack from server (uuid=${state.uuid})`;
        return;
      }

      if (ev === 'frame-color' && body.uuid === state.uuid && typeof body.data === 'string') {
        const b64 = body.data;
        // draw via Image bitmap for speed
        latest.color.img = b64;
        latest.color.ts  = performance.now();
        latest.color.bytes = Math.floor(b64.length * 3 / 4);
        updateStats(latest.color.bytes);
        return;
      }

      if (ev === 'frame-depth' && state.showDepth && body.uuid === state.uuid && typeof body.data === 'string') {
        const b64 = body.data;
        // try as image first (PNG/WEBP/etc)
        latest.depth.data = b64;
        latest.depth.ts   = performance.now();
        latest.depth.bytes= Math.floor(b64.length * 3 / 4);
        latest.depth.isImage = true;
        updateStats(latest.depth.bytes);
        // If you also support raw u16 square payloads, uncomment decode path on draw.
        return;
      }
    }

    async function drawLoop() {
      const frameInterval = Math.max(1.0 / state.fpsCap, 1.0 / 60.0); // seconds
      let last = 0;
      const draw = async (tMs) => {
        const t = tMs / 1000;
        if (!state.running) return;

        if (t - last >= frameInterval) {
          last = t;
          // COLOR
          if (latest.color.img) {
            await drawImageB64ToCanvas(latest.color.img, ui.colorCanvas, ctxColor, overlayText('COLOR'));
          }
          // DEPTH
          if (state.showDepth && latest.depth.data) {
            if (latest.depth.isImage) {
              await drawImageB64ToCanvas(latest.depth.data, ui.depthCanvas, ctxDepth, overlayText('DEPTH'));
            } else {
              // (Optional path for raw u16 if you enable it)
            }
          }

          // overlay metas
          ui.colorMeta.textContent = metaLine();
          if (state.showDepth) ui.depthMeta.textContent = metaLine();
        }

        requestAnimationFrame(draw);
      };
      requestAnimationFrame(draw);
    }

    function metaLine() {
      const Mbps = (state.stats.bps * 8 / 1e6).toFixed(2);
      return `uuid=${state.uuid} • fps=${state.stats.fps.toFixed(1)} • rate=${Mbps} Mbps`;
    }

    function overlayText(tag) {
      return tag;
    }

    async function drawImageB64ToCanvas(b64, canvas, ctx, label) {
      const blob = b64toBlob(b64);
      const bmp = await createImageBitmap(blob);
      // Resize canvas to bitmap dimensions on first draw
      if (canvas.width !== bmp.width || canvas.height !== bmp.height) {
        canvas.width = bmp.width; canvas.height = bmp.height;
      }
      ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);

      // Top overlay bar (semi-transparent)
      ctx.save();
      ctx.globalAlpha = 0.4;
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, 42);
      ctx.restore();
      ctx.font = '16px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial';
      ctx.fillStyle = '#fff';
      ctx.fillText(metaLine(), 12, 26);
    }

    function b64toBlob(b64) {
      const bin = fromB64(b64);
      return new Blob([bin], { type: 'image/*' });
    }

    // Optional: raw u16 depth normalization (if you decide to send raw)
    function normalizeDepthU16ToRGBA(u16arr) {
      // Calculate percentiles
      const len = u16arr.length;
      // Sample for speed if very large
      const step = Math.max(1, Math.floor(len / 10000));
      const sample = [];
      for (let i=0; i<len; i+=step) sample.push(u16arr[i]);
      const p5  = percentile(sample, 5);
      const p95 = Math.max(p5+1, percentile(sample, 95));
      const rgba = new Uint8ClampedArray(len * 4);
      for (let i=0;i<len;i++){
        const v = Math.min(1, Math.max(0, (u16arr[i]-p5)/(p95-p5)));
        const val = Math.round(v * 255);
        rgba[i*4+0] = val; // grayscale -> COLORMAP could be added here
        rgba[i*4+1] = val;
        rgba[i*4+2] = 255 - val;
        rgba[i*4+3] = 255;
      }
      return rgba;
    }

    // ──────────────────────────────────────────────────────────────────────────
    // Lifecycle
    // ──────────────────────────────────────────────────────────────────────────
    async function restart() {
      // Read config
      const cfg = LS.read();
      state.uuid = cfg.viewUuid || '';
      state.showDepth = !!cfg.showDepth;
      state.fpsCap = cfg.fpsCap || 30;
      ui.depthView.style.display = state.showDepth ? '' : 'none';

      if (!cfg.serverHost || !cfg.serverPort || !state.uuid) {
        modal.fillFromLS();
        modal.open();
        return;
      }

      // Bootstrap
      const boot = await fetchBootstrap(cfg.serverHost, cfg.serverPort);
      if (!boot) {
        ui.status.textContent = 'Bootstrap failed. Open Settings and verify host/port.';
        return;
      }
      state.serverSig = boot.SERVER_SIG;
      state.topicPrefix = boot.TOPIC_PREFIX;
      ui.topicChip.textContent = `topic: ${state.topicPrefix}`;
      if (!looksLikeNknAddr(state.serverSig)) {
        ui.status.textContent = `Invalid NKN destination: ${state.serverSig}`;
        return;
      }

      // Create persistent seed
      const seedHex = getOrCreateSeedHex(cfg.clientSeed);
      if (cfg.clientSeed && cfg.clientSeed !== seedHex) {
        localStorage.setItem('CLIENT_NKN_SEED_HEX', cfg.clientSeed); // honor user provided override
      }

      // Stop existing client if any
      if (state.client && state.client.close) {
        try { state.client.close(); } catch {}
      }

      // Start NKN
      state.client = await startClient({ seedHex });
      state.running = true;

      // Soft wait for readiness
      for (let i=0;i<400;i++) {
        if (state.clientAddr) break;
        await sleep(25);
      }
      if (!state.clientAddr) {
        ui.status.textContent = 'NKN client did not become ready.';
        state.running = false;
        return;
      }

      ui.status.textContent = 'Viewer running. Press Settings to change params.';
      drawLoop();
    }

    // First time: open settings if missing
    (function init() {
      const cfg = LS.read();
      if (!cfg.serverHost || !cfg.serverPort || !cfg.viewUuid) {
        modal.fillFromLS();
        modal.open();
      } else {
        restart();
      }
    })();

  })();
  </script>
</body>
</html>
